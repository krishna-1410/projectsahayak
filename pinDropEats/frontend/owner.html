<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PinDrop Eats â€” Restaurant Owner Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app"></div>

    <script src="js/app.js"></script>
    <script>
    const user = requireAuth('owner');
    if (user) init();

    let myRestaurant = null;

    async function init() {
        document.getElementById('app').innerHTML = `
            ${renderNavbar(user)}
            <div class="tabs">
                <button class="tab-btn active" data-tab="tab-orders">ğŸ“¦ Orders</button>
                <button class="tab-btn" data-tab="tab-dishes">ğŸ½ï¸ Dishes</button>
                <button class="tab-btn" data-tab="tab-offers">ğŸ Offers</button>
            </div>
            <div class="tab-panels">
                <div class="tab-content active" id="tab-orders"><div class="container" id="orders-content"></div></div>
                <div class="tab-content" id="tab-dishes"><div class="container" id="dishes-content"></div></div>
                <div class="tab-content" id="tab-offers"><div class="container" id="offers-content"></div></div>
            </div>
        `;
        initTabs();
        loadNotifications();

        window.tabCallbacks = {
            'tab-orders': loadOrders,
            'tab-dishes': loadDishes,
            'tab-offers': loadOffers,
        };

        // Load restaurant info
        try {
            myRestaurant = await apiGet('/api/owner/restaurant');
        } catch(e) {}

        loadOrders();
    }

    // â”€â”€ Orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadOrders() {
        const el = document.getElementById('orders-content');
        try {
            const orders = await apiGet('/api/owner/orders');
            el.innerHTML = `
                <h2 class="mb-2">Orders ${myRestaurant ? 'â€” ' + myRestaurant.name : ''}</h2>
                ${orders.length === 0 ? '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><p>No orders yet</p></div>' : ''}
                ${orders.map(o => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="flex-between mb-1">
                                <div><strong>Order #${o.id}</strong> <span class="text-muted">${formatDate(o.created_at)}</span></div>
                                ${statusBadge(o.order_status)}
                            </div>
                            <div class="text-muted mb-1">ğŸ‘¤ ${o.customer_name || 'Customer'}</div>
                            <div style="font-size:0.9rem" class="mb-1">
                                ${o.items.map(i => `<div>${i.dish_name || 'Item'} Ã— ${i.quantity} â€” ${formatPrice(i.price * i.quantity)}</div>`).join('')}
                            </div>
                            <div class="fw-bold mb-1">Total: ${formatPrice(o.total_amount)}</div>
                            <div class="flex flex-gap flex-wrap">
                                ${getOrderActions(o)}
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        } catch (err) { el.innerHTML = `<div class="alert alert-danger">${err.message}</div>`; }
    }

    function getOrderActions(order) {
        const s = order.order_status;
        let btns = '';
        if (s === 'Placed') {
            btns += `<button class="btn btn-success btn-sm" onclick="updateStatus(${order.id}, 'Accepted')">âœ“ Accept</button>`;
            btns += `<button class="btn btn-danger btn-sm" onclick="updateStatus(${order.id}, 'Rejected')">âœ• Reject</button>`;
        }
        if (s === 'Accepted') {
            btns += `<button class="btn btn-primary btn-sm" onclick="updateStatus(${order.id}, 'Preparing')">ğŸ³ Start Preparing</button>`;
        }
        if (s === 'Preparing') {
            btns += `<button class="btn btn-success btn-sm" onclick="updateStatus(${order.id}, 'Out for Delivery')">ğŸš€ Send for Delivery</button>`;
        }
        return btns;
    }

    async function updateStatus(orderId, status) {
        try {
            const result = await apiPut(`/api/owner/orders/${orderId}/status`, { status });
            showToast(result.message, 'success');
            loadOrders();
        } catch (err) { showToast(err.message, 'error'); }
    }

    // â”€â”€ Dishes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDishes() {
        const el = document.getElementById('dishes-content');
        try {
            const dishes = await apiGet('/api/owner/dishes');
            el.innerHTML = `
                <div class="flex-between mb-2">
                    <h2>My Dishes</h2>
                    <button class="btn btn-primary" onclick="document.getElementById('add-dish-form').classList.toggle('hidden')">+ Add Dish</button>
                </div>
                <div id="add-dish-form" class="card mb-2 hidden">
                    <div class="card-body">
                        <h3 class="mb-1">Add New Dish</h3>
                        <div class="grid grid-2">
                            <div class="form-group"><label>Name</label><input id="d-name" class="form-control" placeholder="Dish name"></div>
                            <div class="form-group"><label>Price (â‚¹)</label><input id="d-price" type="number" class="form-control" placeholder="0"></div>
                            <div class="form-group"><label>Image URL</label><input id="d-image" class="form-control" placeholder="https://..."></div>
                            <div class="form-group"><label>Available</label><select id="d-avail" class="form-control"><option value="true">Yes</option><option value="false">No</option></select></div>
                        </div>
                        <button class="btn btn-success" onclick="addDish()">Save</button>
                    </div>
                </div>
                <div class="grid grid-3">
                    ${dishes.map(d => `
                        <div class="dish-card">
                            <img src="${d.image_path || 'https://via.placeholder.com/400x200?text=Food'}" alt="${d.name}" onerror="this.src='https://via.placeholder.com/400x200?text=Food'">
                            <div class="dish-info">
                                <div class="dish-name">${d.name}</div>
                                <div class="dish-price">${formatPrice(d.price)}</div>
                                <div>${d.availability ? '<span class="text-success">Available</span>' : '<span class="text-danger">Unavailable</span>'}</div>
                            </div>
                            <div class="dish-actions">
                                <button class="btn btn-sm btn-outline" onclick="toggleDishAvail(${d.id}, ${!d.availability})">${d.availability ? 'Mark Unavailable' : 'Mark Available'}</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteDish(${d.id})">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (err) { el.innerHTML = `<div class="alert alert-danger">${err.message}</div>`; }
    }

    async function addDish() {
        if (!myRestaurant) { showToast('No restaurant linked to your account', 'error'); return; }
        const name = document.getElementById('d-name').value.trim();
        const price = parseFloat(document.getElementById('d-price').value);
        const image_path = document.getElementById('d-image').value.trim();
        const availability = document.getElementById('d-avail').value === 'true';
        if (!name || !price) { showToast('Name and price are required', 'error'); return; }
        try {
            await apiPost('/api/owner/dishes', { name, price, image_path, availability, restaurant_id: myRestaurant.id });
            showToast('Dish added!', 'success');
            loadDishes();
        } catch (err) { showToast(err.message, 'error'); }
    }

    async function toggleDishAvail(dishId, newAvail) {
        try {
            await apiPut(`/api/owner/dishes/${dishId}`, { availability: newAvail });
            showToast('Dish updated!', 'success');
            loadDishes();
        } catch (err) { showToast(err.message, 'error'); }
    }

    async function deleteDish(dishId) {
        if (!confirm('Delete this dish?')) return;
        try {
            await apiDelete(`/api/owner/dishes/${dishId}`);
            showToast('Dish removed', 'success');
            loadDishes();
        } catch (err) { showToast(err.message, 'error'); }
    }

    // â”€â”€ Offers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadOffers() {
        const el = document.getElementById('offers-content');
        try {
            const offers = await apiGet('/api/owner/offers');
            el.innerHTML = `
                <div class="flex-between mb-2">
                    <h2>Restaurant Offers</h2>
                    <button class="btn btn-primary" onclick="document.getElementById('add-offer-form').classList.toggle('hidden')">+ Add Offer</button>
                </div>
                <div id="add-offer-form" class="card mb-2 hidden">
                    <div class="card-body">
                        <h3 class="mb-1">New Restaurant Offer</h3>
                        <div class="form-group"><label>Description</label><input id="o-desc" class="form-control" placeholder="e.g. Special 20% off!"></div>
                        <div class="grid grid-2">
                            <div class="form-group"><label>Discount (%)</label><input id="o-pct" type="number" class="form-control" placeholder="10"></div>
                            <div class="form-group"><label>Min Order Value (â‚¹)</label><input id="o-min" type="number" class="form-control" placeholder="200"></div>
                        </div>
                        <button class="btn btn-success" onclick="addOffer()">Save</button>
                    </div>
                </div>
                ${offers.length === 0 ? '<div class="text-muted text-center p-2">No restaurant offers yet</div>' : `
                <div class="table-wrap"><table>
                    <thead><tr><th>ID</th><th>Description</th><th>Discount</th><th>Min Value</th></tr></thead>
                    <tbody>
                        ${offers.map(o => `<tr>
                            <td>${o.id}</td><td>${o.description}</td><td>${o.discount_percentage}%</td><td>${formatPrice(o.minimum_order_value)}</td>
                        </tr>`).join('')}
                    </tbody>
                </table></div>`}
            `;
        } catch (err) { el.innerHTML = `<div class="alert alert-danger">${err.message}</div>`; }
    }

    async function addOffer() {
        const description = document.getElementById('o-desc').value.trim();
        const discount_percentage = parseFloat(document.getElementById('o-pct').value);
        const minimum_order_value = parseFloat(document.getElementById('o-min').value);
        if (!description || !discount_percentage || !minimum_order_value) { showToast('Fill all fields', 'error'); return; }
        try {
            await apiPost('/api/owner/offers', { description, discount_percentage, minimum_order_value, applicable_type: 'restaurant' });
            showToast('Offer created!', 'success');
            loadOffers();
        } catch (err) { showToast(err.message, 'error'); }
    }
    </script>
</body>
</html>
